left_join(country_gdpep, by = c("CountryCorrFinal", "country_nr")) %>%
mutate(frac_GDPEP = GDPEP / coun_gdpep)
conn <- dbConnect(RSQLite::SQLite(), "data/raw/substance_properties.db")
dbListTables(conn)
sub_props <-
dbGetQuery(
conn,
"SELECT ID, CAS, property, value FROM substance_properties WHERE property IN ('Molar mass [Da]', 'log Kow', 'Kbiodeg [1/s]', 'Ks')"
) %>%
mutate(value = as.numeric(value)) %>%
filter(CAS %in% measurements$CAS_No) %>%
spread(key = property, value = value) %>%
select(CAS, `Kbiodeg [1/s]`, `log Kow`, `Molar mass [Da]`, Ks) %>%
group_by(CAS) %>%
summarise(
molar_mass = mean(`Molar mass [Da]`, na.rm = TRUE),
log_kow = mean(`log Kow`, na.rm = TRUE),
kbiodeg = mean(`Kbiodeg [1/s]`, na.rm = TRUE),
ks = mean(Ks, na.rm = TRUE)
) %>%
ungroup()
sub_groups <- dbGetQuery(
conn,
"SELECT CAS, CODE FROM substances"
) %>%
filter(CAS %in% measurements$CAS_No) %>%
mutate(CODE = tolower(CODE)) %>%
mutate(pest = str_detect(CODE, "pest"),
pharma = str_detect(CODE, "pharma"),
reach = str_detect(CODE, "reach")
) #%>%
# select(-CODE)
sub_groups <- sub_groups[!duplicated(sub_groups$CAS), ]
# Joining data  -----------------------------------------------------------
data_tot <-
left_join(measurements_mapping,
measurements ,
by = c("station_co" = "Station_Code")) %>%
left_join(geo_hydro, by = "SUBID") %>%
left_join(catch, by = "SUBID") %>%
left_join(demo, by = c("SUBID" = "SC")) %>%
left_join(sub_props, by = c("CAS_No" = "CAS")) %>%
left_join(sub_groups, by = c("CAS_No" = "CAS"))
data <- data_tot %>%
select(
HAROID,
MAINDOWN,
SUBID,
CountryCorrFinal,
country_nr,
LAKEREGION,
REGION,
WQPARREG,
POURX,
POURY,
TARGETX,
TARGETY,
CENTERX,
CENTERY,
LATITUDE,
LONGITUDE,
station_co,
Substance,
CAS_No,
H_Unit,
Concentration,
subs_value,
valid_measurement,
kbiodeg,
log_kow,
molar_mass,
ks,
reach,
pest,
pharma,
AREA,
area_agr,
UPAREA,
RIVLEN,
ELEV_MEAN,
ELEV_STD,
SLOPE_MEAN,
RELIEF,
SLC_1:CumCat_km2,
GDPEP,
frac_GDPEP,
distance_t,
CumAreakkm2
) %>%
mutate(  # recalculating units to one standard #
subs_value = case_when(
H_Unit == "mg/l" ~ subs_value * 1000,
H_Unit == "mg/kg" ~ subs_value * 1000,
TRUE ~ subs_value
),
H_Unit = case_when(H_Unit == "mg/l" ~ "µg/l",
H_Unit == "mg/kg" ~ "µg/kg",
TRUE ~ H_Unit)
) %>%
filter(H_Unit != "µg/kg")
# removing missing measurement
data <- data[!is.na(data$subs_value), ]
# calculate fraction agricultural are for each subid #
data <- mutate(data, f_agr = area_agr / AREA)
# adding flag for substances that belong to multiple groups
data$mult_groups <- rowSums(data[,c('reach', 'pharma', 'pest')], na.rm = TRUE)
# making sure that every substance only belongs to one group using priorities #
data <-
mutate(
data,
reach_bin = if_else(reach == TRUE & mult_groups == 1, 1 , 0),
pharma_bin = if_else(
pharma == TRUE & mult_groups == 1 | pharma == TRUE & pest != TRUE & mult_groups > 1,
1 , 0),
pest_bin = if_else(pest == TRUE, 1 , 0, missing = 0)
)
# making on column for the groups
data$sub_groups <- case_when(data$reach_bin == 1 ~ "reach",
data$pharma_bin == 1 ~ " pharma",
data$pest_bin == 1 ~ "pest")
# Obtaining emissions data ------------------------------------------------
emission_files <- list.files(path = "data/raw/emission-data/", pattern = "*.dbg", full.names = TRUE)
emission_data <- NULL
# file <- "data/raw/emission-data/espaceCAS_100-41-4.dbg"
for (file in emission_files) {
cas <- str_extract(basename(file), "\\d{1,}-\\d{1,2}-\\d{1}")
df <-
read_table2(
file = file,
skip = 2,
col_names = FALSE,
col_types =  cols(X1 = col_integer(),
X2 = col_double(),
X3 = col_double())
)
skip <- which(is.na(df$X1))
df <- df[-c(1:skip[2]), ]
colnames(df) <- c("country_nr" ,"emission_air_raw", "emission_water_raw", "emission_ww_raw", "emission_soil_raw", "unknown")
df$cas <- cas
emission_data <- bind_rows(emission_data, df)
}
# cleaning and joining emission data #
emission_data <- select(emission_data, country_nr, cas, emission_air_raw:emission_soil_raw)
data <- left_join(data, emission_data, by = c("country_nr" = "country_nr" , "CAS_No" = "cas"))
# calculating emissions based on substance group #
data <- mutate(
data,
emission_air = case_when(
pest_bin == 1 ~ emission_air_raw * f_agr,
pest_bin != 1 ~ emission_air_raw * frac_GDPEP
),
emission_water = case_when(
pest_bin == 1 ~ emission_water_raw * f_agr,
pest_bin != 1 ~ emission_water_raw * frac_GDPEP
),
emission_ww = case_when(
pest_bin == 1 ~ emission_ww_raw * f_agr,
pest_bin != 1 ~ emission_ww_raw * frac_GDPEP
),
emission_soil = case_when(
pest_bin == 1 ~ emission_soil_raw * f_agr,
pest_bin != 1 ~ emission_soil_raw * frac_GDPEP
)
)
# creating intermediate datset #
data_intermediate <- data
# create data for later use #
data <- select(
data,
-HAROID,
-REGION
-LAKEDATAID,
-LAKE_DEPTH,  # always the same
-ICATCH,  # always the same
-loc_sp,
-loc_in,
-frac_GDPEP,
-f_agr,
-emission_air_raw,
-emission_water_raw,
-emission_ww_raw,
-emission_soil_raw,
-mult_groups,
-reach,
-pest,
-pharma,
-drydep_n2,  # drydep_n1 & drydep_n2 are the same?
-WQPARREG  # always the same
)
# Loading libraries -------------------------------------------------------
library(tidyverse)
library(naniar)
# Loading data ------------------------------------------------------------
df <- read_rds("data/modified/compact_data.rds")
# Cleaning data for feature table #
# Cleaning data for feature table #
df <- select(df, -SUBID:-Concentration, -valid_measurement, -sub_groups)
# Cleaning data for feature table #
df <- select(df, -SUBID:-Concentration, -valid_measurement, -sub_groups)
names(df)
# Loading libraries -------------------------------------------------------
library(tidyverse)
library(naniar)
# Loading data ------------------------------------------------------------
df <- read_rds("data/modified/compact_data.rds")
# Cleaning data for feature table #
df <- select(df, -SUBID:-Concentration, -valid_measurement, -sub_groups)
# first test removing al missing values (for now) #
df <- na.omit(df)
library(ranger)
install.packages("ranger")
library(ranger)
summary(df$subs_value)
boxplot(df$subs_value)
# Loading libraries -------------------------------------------------------
library(tidyverse)
library(naniar)
library(ranger)
# Loading data ------------------------------------------------------------
df <- read_rds("data/modified/compact_data.rds")
# Cleaning data for feature table #
df <- select(df, -SUBID:-Concentration, -valid_measurement, -sub_groups)
boxplot(df$subs_value)
summary(df$subs_value)
# first test removing al missing values (for now) #
df <- na.omit(df)
summary(df$subs_value)
boxplot(df$subs_value)
names(df)
fmla <- "subs_value ~ ."
# test model #
subs_model_rf <-
ranger(
formula = fmla,
data = df,
num.trees = 500,
respect.unordered.factors = "order"
)
# test model #
(subs_model_rf <-
ranger(
formula = fmla,
data = df,
num.trees = 500,
respect.unordered.factors = "order"
))
subs_model_rf
str(df)
library(xgboost)
install.packages("xgboost")
library(xgboost)
as.matrix(df)
# test model xgboost #
cv <-
xgb.cv(
data = as.matrix(df),
label = df$subs_value,
nrounds = 100,
nfold = 5,
objective = "reg:linear",
eta = 0.3,
max_depth = 6,
early_stopping_rounds = 10,
verbose = 0
)
elog <- cv$evaluation_log
elog %>%
summarize(ntrees.train = which.min(train_rmse_mean),   # find the index of min(train_rmse_mean)
ntrees.test  = which.min(test_rmse_mean))
subs_model_xgb <- xgboost(data = as.matrix(df),
label = df$subs_value,
nrounds = 20,
objective = "reg:linear",
eta = 0.3,
depth = 6,
verbose = 0)
subs_model_xgb
subs_model_rf
sqrt(0.004287928)
data("stanford2")
source('P:/1209104-solutions/JDS_ML/github_repo_JDS_ML/JDS_ML/emerging_sub_worldbank_R/scripts/Cleaning_data.R', encoding = 'UTF-8', echo=TRUE)
source('P:/1209104-solutions/JDS_ML/github_repo_JDS_ML/JDS_ML/emerging_sub_worldbank_R/scripts/Cleaning_data.R', encoding = 'UTF-8', echo=TRUE)
summarry(data$emission_air)
summary(data$emission_air)
summary(data$emission_ww)
summary(data$emission_water)
summary(data$emission_soil)
# Loading libraries -------------------------------------------------------
library(tidyverse)
library(FactorMiner)
install.packages("FactorMiner")
library(FactoMiner)
install.packages("FactoMiner")
library(FactoMineR)
df <- read_rds("data/modified/compact_data.rds")
names(data)
names(df)
# PCA #
pca_df <-
select(
df,
-SUBID,
-CountryCorrFinal,
-country_nr,
-LAKEREGION,
-POURX,
-POURY,
-TARGETX,
-TARGETY,
-CENTERX,
-CENTERY,
-LATITUDE,
-LONGITUDE,
-station_co,
-Substance,
-CAS_No,
-CAS_No,
-H_Unit,
-Concentration,
-valid_measurement
)
pca_all <- pca_output_all <- PCA(pca_df, quanti.sup = 1:8, quali.sup = 20:21, graph = )
names(pca_df)
pca_all <- pca_output_all <- PCA(pca_df, quanti.sup = 99:101, quali.sup = 102, graph = TRUE)
dimdesc(pca_all, axes = 1:2)
pca_all$var
pca_all$eig[,2][1:5]
pca_all$eig[,3][1:5]
pca_all$eig[,2][1:20]
pca_all$eig[,3][1:20]
summary(pca_all, nbelements = 100)
summary(pca_all)
?PCA
library(factoextra)
fviz_cos2(pca_all, choice = "var", axes = 1, top = 10)
fviz_cos2(pca_all, choice = "var", axes = 2, top = 10)
fviz_contrib(pca_all, choice = "var", axes = 1, top = 10)
fviz_contrib(pca_all, choice = "var", axes = 2, top = 10)
# Loading libraries -------------------------------------------------------
library(FactoMineR)
library(factoextra)
library(paran)
library(psych)
library(tidyverse)
# Loading data ------------------------------------------------------------
df <- read_rds("data/modified/compact_data.rds")
# PCA #
pca_df <-
select(
df,
-SUBID,
-CountryCorrFinal,
-country_nr,
-LAKEREGION,
-POURX,
-POURY,
-TARGETX,
-TARGETY,
-CENTERX,
-CENTERY,
-LATITUDE,
-LONGITUDE,
-station_co,
-Substance,
-CAS_No,
-CAS_No,
-H_Unit,
-Concentration,
-valid_measurement
)
pca_all <- PCA(pca_df, quanti.sup = 99:101, quali.sup = 102, graph = TRUE)
summary(pca_all)
dimdesc(pca_all, axes = 1:2)
pca_all$eig[,2][1:30]
pca_all$eig[,3][1:30]
pca_all$var
fviz_cos2(pca_all, choice = "var", axes = 1, top = 10)
fviz_cos2(pca_all, choice = "var", axes = 2, top = 10)
fviz_contrib(pca_all, choice = "var", axes = 1, top = 10)
fviz_contrib(pca_all, choice = "var", axes = 2, top = 10)
fviz_screeplot(pca_all, ncp = 20)
get_eigenvalue(pca_all)
select(pca_df, ks)
pca_df
select(pca_df, subs_value, AREA:pest_bin)
sum(is.na(select(pca_df, subs_value, AREA:pest_bin)))
# parallel analysis #
paran_df <- select(pca_df, subs_value, AREA:pest_bin)
paran(paran_df, graph = TRUE)
fa.parallel(paran_df)
sum(is.na(paran_df))
sum(is.infinite(paran_df))
paran_df %>% mutate_if(is.numeric, list(~na_if(., Inf)))
sum(is.na(paran_df))
paran_df %>% mutate_if(is.numeric, list(~na_if(., Inf))) %>% is.na()
paran_df %>% mutate_if(is.numeric, list(~na_if(., Inf))) %>% is.na() %>% sum()
paran_df %>% mutate_if(is.numeric, list(~na_if(., -Inf))) %>% is.na() %>% sum()
# parallel analysis #
paran_df <- select(pca_df, subs_value, AREA:pest_bin)
any(is.na(paran_df))
any(is.infinite(paran_df))
apply(paran_df, 2, function(x) any(is.infinite(x)))
# parallel analysis #
paran_df <- select(pca_df, subs_value, AREA:CumAreakkm2)
paran(paran_df, graph = TRUE)
# parallel analysis #
paran_df <- complete.cases(select(pca_df, subs_value, AREA:CumAreakkm2))
paran(paran_df, graph = TRUE)
fa.parallel(paran_df)
# parallel analysis #
paran_df <- select(pca_df, subs_value, AREA:CumAreakkm2)
paran_df
# parallel analysis #
paran_df <- as.dataframe(select(pca_df, subs_value, AREA:CumAreakkm2))
# parallel analysis #
paran_df <- as.data.frame(select(pca_df, subs_value, AREA:CumAreakkm2))
paran(paran_df, graph = TRUE)
# parallel analysis #
paran_df <- as.data.frame(complete.cases(select(pca_df, subs_value, AREA:CumAreakkm2)))
paran(paran_df, graph = TRUE)
fa.parallel(paran_df)
?paran
paran(pca_all, graph = TRUE)
fa.parallel(pca_all)
pca_all
as.matrix(paran_df)
paran(as.matrix(paran_df), graph = TRUE)
apply(paran_df, 2, function(x) any(is.infinite(x)))
paran_df
# parallel analysis #
paran_df <- as.data.frame(complete.cases(select(pca_df, subs_value, AREA:CumAreakkm2)))
paran_df
select(pca_df, subs_value, AREA:CumAreakkm2)
complete.cases(select(pca_df, subs_value, AREA:CumAreakkm2))
# parallel analysis #
paran_df <- select(pca_df, subs_value, AREA:CumAreakkm2)
paran_df
paran_df <- as.data.frame(paran_df[complete.cases(paran_df), ])
paran_df
paran(paran_df, graph = TRUE)
paran(as.matrix(paran_df), graph = TRUE)
paran(paran_df, graph = TRUE)
get_eigenvalue(pca_all)
pca_all$eig[,2][1:30]
summary(pca_all)
pca_all
str(pca_all)
install.packages("Rtsne")
library(Rtsne)
# t-SNE
tsne_df <- select(pca_df, AREA:CumAreakkm2)
tsne_output <- Rtsne(tsne_df, perplexity = 50, max_iter = 1200, dims = 3)
# Loading libraries -------------------------------------------------------
library(FactoMineR)
library(factoextra)
library(paran)
library(psych)
library(tidyverse)
library(Rtsne)
# Loading data ------------------------------------------------------------
df <- read_rds("data/modified/compact_data.rds")
# PCA #
pca_df <-
select(
df,
-SUBID,
-CountryCorrFinal,
-country_nr,
-LAKEREGION,
-POURX,
-POURY,
-TARGETX,
-TARGETY,
-CENTERX,
-CENTERY,
-LATITUDE,
-LONGITUDE,
-station_co,
-Substance,
-CAS_No,
-CAS_No,
-H_Unit,
-Concentration,
-valid_measurement
)
pca_all <- PCA(pca_df, quanti.sup = 99:101, quali.sup = 102, graph = TRUE)
summary(pca_all)
dimdesc(pca_all, axes = 1:2)
pca_all$eig[,2][1:30]
pca_all$eig[,3][1:30]
pca_all$var
fviz_cos2(pca_all, choice = "var", axes = 1, top = 10)
fviz_cos2(pca_all, choice = "var", axes = 2, top = 10)
fviz_contrib(pca_all, choice = "var", axes = 1, top = 10)
fviz_contrib(pca_all, choice = "var", axes = 2, top = 10)
fviz_screeplot(pca_all, ncp = 20)
get_eigenvalue(pca_all)
# parallel analysis #
paran_df <- select(pca_df, subs_value, AREA:CumAreakkm2)
paran_df <- as.data.frame(paran_df[complete.cases(paran_df), ])
paran(paran_df, graph = TRUE)
fa.parallel(paran_df)
# t-SNE #
tsne_df <- select(pca_df, AREA:CumAreakkm2)
tsne_output <- Rtsne(tsne_df, perplexity = 50, max_iter = 1200, dims = 3)
tsne_df[duplicated(tsne_df), ]
tsne_df[unique(tsne_df), ]
tsne_df[duplicated(tsne_df), ]
tsne_df[duplicated(paran_df), ]
tsne_output <- Rtsne(paran_df, perplexity = 50, max_iter = 1200, dims = 3)
tsne_output <- Rtsne(paran_df, perplexity = 50, max_iter = 1200, dims = 3, check_duplicates = FALSE)
tsne_output
